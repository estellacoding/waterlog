<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å–®å…ƒæ¸¬è©¦ - æ°´ç²¾éˆé¤Šæˆè¨˜</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        h1 { color: #0984e3; }
        .test-suite {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .test-case {
            padding: 10px;
            margin: 5px 0;
            border-left: 4px solid #ddd;
            background: #f8f9fa;
        }
        .test-case.pass {
            border-left-color: #00b894;
            background: #e8f8f5;
        }
        .test-case.fail {
            border-left-color: #d63031;
            background: #ffe8e8;
        }
        .summary {
            background: #0984e3;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            font-weight: bold;
        }
        .error-detail {
            color: #d63031;
            font-size: 0.9em;
            margin-top: 5px;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <h1>ğŸ§ª å–®å…ƒæ¸¬è©¦</h1>
    <div id="test-results"></div>
    <div id="summary" class="summary"></div>

    <script src="script.js"></script>
    <script>
        // ç°¡å–®çš„æ¸¬è©¦æ¡†æ¶
        class TestRunner {
            constructor() {
                this.results = [];
                this.currentSuite = null;
            }

            describe(name, fn) {
                this.currentSuite = { name, tests: [] };
                fn();
                this.results.push(this.currentSuite);
                this.currentSuite = null;
            }

            it(description, fn) {
                try {
                    fn();
                    this.currentSuite.tests.push({ description, passed: true });
                } catch (error) {
                    this.currentSuite.tests.push({ 
                        description, 
                        passed: false, 
                        error: error.message 
                    });
                }
            }

            assert(condition, message) {
                if (!condition) {
                    throw new Error(message || 'æ–·è¨€å¤±æ•—');
                }
            }

            assertEqual(actual, expected, message) {
                if (actual !== expected) {
                    throw new Error(message || `é æœŸ ${expected}ï¼Œå¯¦éš› ${actual}`);
                }
            }

            assertThrows(fn, message) {
                try {
                    fn();
                    throw new Error(message || 'é æœŸæ‹‹å‡ºéŒ¯èª¤ä½†æ²’æœ‰');
                } catch (error) {
                    if (error.message === message || message === undefined) {
                        return;
                    }
                    // å¦‚æœæ˜¯é æœŸçš„éŒ¯èª¤ï¼Œé€šéæ¸¬è©¦
                    return;
                }
            }

            render() {
                const container = document.getElementById('test-results');
                let totalTests = 0;
                let passedTests = 0;

                this.results.forEach(suite => {
                    const suiteDiv = document.createElement('div');
                    suiteDiv.className = 'test-suite';
                    suiteDiv.innerHTML = `<h2>${suite.name}</h2>`;

                    suite.tests.forEach(test => {
                        totalTests++;
                        if (test.passed) passedTests++;

                        const testDiv = document.createElement('div');
                        testDiv.className = `test-case ${test.passed ? 'pass' : 'fail'}`;
                        testDiv.innerHTML = `
                            <strong>${test.passed ? 'âœ“' : 'âœ—'}</strong> ${test.description}
                            ${test.error ? `<div class="error-detail">${test.error}</div>` : ''}
                        `;
                        suiteDiv.appendChild(testDiv);
                    });

                    container.appendChild(suiteDiv);
                });

                const summary = document.getElementById('summary');
                summary.innerHTML = `
                    æ¸¬è©¦å®Œæˆ: ${passedTests}/${totalTests} é€šé 
                    (${Math.round(passedTests/totalTests*100)}%)
                `;
            }
        }

        const runner = new TestRunner();

        // ==================== LocalStorage Manager æ¸¬è©¦ ====================
        runner.describe('LocalStorage Manager', () => {
            const manager = new LocalStorageManager();

            runner.it('æ‡‰è©²èƒ½å‰µå»ºé è¨­éŠæˆ²æ•¸æ“š', () => {
                const data = manager.createDefaultGameData();
                runner.assert(data.level === 1, 'é è¨­ç­‰ç´šæ‡‰ç‚º1');
                runner.assert(data.exp === 0, 'é è¨­ç¶“é©—å€¼æ‡‰ç‚º0');
                runner.assert(data.todayAmount === 0, 'é è¨­ä»Šæ—¥æ°´é‡æ‡‰ç‚º0');
                runner.assert(Array.isArray(data.history), 'æ­·å²è¨˜éŒ„æ‡‰ç‚ºé™£åˆ—');
            });

            runner.it('æ‡‰è©²é©—è­‰æœ‰æ•ˆçš„éŠæˆ²æ•¸æ“š', () => {
                const validData = {
                    level: 1,
                    exp: 0,
                    maxExp: 100,
                    todayAmount: 0,
                    dailyGoal: 2000,
                    totalAmount: 0,
                    history: [],
                    achievements: []
                };
                runner.assert(manager.validateGameData(validData), 'æœ‰æ•ˆæ•¸æ“šæ‡‰é€šéé©—è­‰');
            });

            runner.it('æ‡‰è©²æ‹’çµ•ç„¡æ•ˆçš„ç­‰ç´šæ•¸å€¼', () => {
                const invalidData = {
                    level: -1,
                    exp: 0,
                    maxExp: 100,
                    todayAmount: 0,
                    dailyGoal: 2000,
                    totalAmount: 0,
                    history: [],
                    achievements: []
                };
                runner.assertThrows(() => manager.validateGameData(invalidData));
            });

            runner.it('æ‡‰è©²æª¢æŸ¥ LocalStorage å¯ç”¨æ€§', () => {
                const available = manager.isStorageAvailable();
                runner.assert(typeof available === 'boolean', 'æ‡‰è¿”å›å¸ƒæ—å€¼');
            });
        });

        // ==================== æ•¸æ“šè¨ˆç®—é‚è¼¯æ¸¬è©¦ ====================
        runner.describe('æ•¸æ“šè¨ˆç®—é‚è¼¯', () => {
            runner.it('æ‡‰è©²æ­£ç¢ºè¨ˆç®—ç¶“é©—å€¼', () => {
                const amount = 250;
                const expectedExp = Math.floor(amount / 10);
                runner.assertEqual(expectedExp, 25, '250ml æ‡‰ç²å¾— 25 ç¶“é©—å€¼');
            });

            runner.it('æ‡‰è©²æ­£ç¢ºè¨ˆç®—é€²åº¦ç™¾åˆ†æ¯”', () => {
                const todayAmount = 1000;
                const dailyGoal = 2000;
                const progress = Math.min((todayAmount / dailyGoal) * 100, 100);
                runner.assertEqual(progress, 50, '1000/2000 æ‡‰ç‚º 50%');
            });

            runner.it('é€²åº¦ç™¾åˆ†æ¯”ä¸æ‡‰è¶…é100%', () => {
                const todayAmount = 3000;
                const dailyGoal = 2000;
                const progress = Math.min((todayAmount / dailyGoal) * 100, 100);
                runner.assertEqual(progress, 100, 'è¶…éç›®æ¨™æ‡‰é¡¯ç¤º 100%');
            });
        });

        // ==================== æ—¥æœŸæ™‚é–“è™•ç†æ¸¬è©¦ ====================
        runner.describe('æ—¥æœŸæ™‚é–“è™•ç†', () => {
            runner.it('æ‡‰è©²æ­£ç¢ºæ ¼å¼åŒ–æ™‚é–“', () => {
                const date = new Date('2024-01-01T10:30:00');
                const timeString = date.toLocaleTimeString('zh-TW', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                runner.assert(timeString.includes('10'), 'æ‡‰åŒ…å«å°æ™‚');
                runner.assert(timeString.includes('30'), 'æ‡‰åŒ…å«åˆ†é˜');
            });

            runner.it('æ‡‰è©²æ­£ç¢ºæ¯”è¼ƒæ—¥æœŸ', () => {
                const today = new Date().toDateString();
                const yesterday = new Date(Date.now() - 86400000).toDateString();
                runner.assert(today !== yesterday, 'ä»Šå¤©å’Œæ˜¨å¤©çš„æ—¥æœŸæ‡‰ä¸åŒ');
            });

            runner.it('æ‡‰è©²æ­£ç¢ºè¨ˆç®—é€±å¹¾', () => {
                const date = new Date();
                const dayOfWeek = date.getDay();
                runner.assert(dayOfWeek >= 0 && dayOfWeek <= 6, 'é€±å¹¾æ‡‰åœ¨ 0-6 ä¹‹é–“');
            });
        });

        // ==================== è¨­å®šé©—è­‰æ¸¬è©¦ ====================
        runner.describe('è¨­å®šé©—è­‰', () => {
            const settingsPanel = new SettingsPanel(new AppStateManager());

            runner.it('æ‡‰è©²é©—è­‰æ¯æ—¥ç›®æ¨™ç¯„åœ', () => {
                const validSettings = {
                    dailyGoal: 2000,
                    quickButtons: [250, 500, 100],
                    notifications: { enabled: false, schedule: [] },
                    theme: 'auto'
                };
                runner.assert(
                    settingsPanel.validateSettings(validSettings),
                    'æœ‰æ•ˆè¨­å®šæ‡‰é€šéé©—è­‰'
                );
            });

            runner.it('æ‡‰è©²æ‹’çµ•è¶…å‡ºç¯„åœçš„æ¯æ—¥ç›®æ¨™', () => {
                const invalidSettings = {
                    dailyGoal: 6000,
                    quickButtons: [250, 500, 100],
                    notifications: { enabled: false, schedule: [] },
                    theme: 'auto'
                };
                runner.assertThrows(() => settingsPanel.validateSettings(invalidSettings));
            });

            runner.it('æ‡‰è©²é©—è­‰å¿«é€ŸæŒ‰éˆ•æ•¸é‡', () => {
                const invalidSettings = {
                    dailyGoal: 2000,
                    quickButtons: [250, 500],
                    notifications: { enabled: false, schedule: [] },
                    theme: 'auto'
                };
                runner.assertThrows(() => settingsPanel.validateSettings(invalidSettings));
            });
        });

        // ==================== çµ±è¨ˆè¨ˆç®—æ¸¬è©¦ ====================
        runner.describe('çµ±è¨ˆè¨ˆç®—', () => {
            const appState = new AppStateManager();
            appState.initialize();
            const dashboard = new DashboardSystem(appState);

            runner.it('æ‡‰è©²æ­£ç¢ºè¨ˆç®—æ¯æ—¥çµ±è¨ˆ', () => {
                const gameData = {
                    todayAmount: 1500,
                    dailyGoal: 2000,
                    history: [
                        { amount: 500, time: '09:00' },
                        { amount: 500, time: '12:00' },
                        { amount: 500, time: '15:00' }
                    ]
                };
                const stats = dashboard.calculateDailyStats(gameData);
                runner.assertEqual(stats.totalAmount, 1500, 'ç¸½é‡æ‡‰ç‚º 1500ml');
                runner.assertEqual(stats.entryCount, 3, 'è¨˜éŒ„æ•¸æ‡‰ç‚º 3');
                runner.assertEqual(stats.averagePerEntry, 500, 'å¹³å‡æ¯æ¬¡æ‡‰ç‚º 500ml');
            });

            runner.it('æ‡‰è©²æ­£ç¢ºåˆ¤æ–·ç›®æ¨™é”æˆ', () => {
                const gameData = {
                    todayAmount: 2000,
                    dailyGoal: 2000,
                    history: []
                };
                const stats = dashboard.calculateDailyStats(gameData);
                runner.assert(stats.goalAchieved, 'æ‡‰åˆ¤æ–·ç‚ºå·²é”æ¨™');
            });

            runner.it('æ‡‰è©²æ­£ç¢ºè¨ˆç®—å‰©é¤˜æ°´é‡', () => {
                const gameData = {
                    todayAmount: 1200,
                    dailyGoal: 2000,
                    history: []
                };
                const stats = dashboard.calculateDailyStats(gameData);
                runner.assertEqual(stats.remainingAmount, 800, 'å‰©é¤˜æ‡‰ç‚º 800ml');
            });
        });

        // åŸ·è¡Œæ¸¬è©¦ä¸¦é¡¯ç¤ºçµæœ
        runner.render();
    </script>
</body>
</html>
