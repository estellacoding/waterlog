<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•´åˆæ¸¬è©¦ - æ°´ç²¾éˆé¤Šæˆè¨˜</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .test-panel {
            position: fixed;
            top: 0;
            right: 0;
            width: 400px;
            height: 100vh;
            background: white;
            box-shadow: -2px 0 10px rgba(0,0,0,0.2);
            padding: 20px;
            overflow-y: auto;
            z-index: 10000;
        }
        .test-panel h2 {
            color: #0984e3;
            margin-top: 0;
        }
        .test-section {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .test-button {
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            background: #0984e3;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }
        .test-button:hover {
            background: #0770c4;
        }
        .test-result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            font-size: 13px;
        }
        .test-result.success {
            background: #d4edda;
            color: #155724;
        }
        .test-result.error {
            background: #f8d7da;
            color: #721c24;
        }
        .test-result.info {
            background: #d1ecf1;
            color: #0c5460;
        }
        .test-log {
            max-height: 200px;
            overflow-y: auto;
            background: #2d3436;
            color: #dfe6e9;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            margin-top: 10px;
        }
        .test-log div {
            margin: 2px 0;
        }
    </style>
</head>
<body>
    <!-- ä¸»æ‡‰ç”¨ç¨‹å¼ -->
    <div class="container">
        <header>
            <h1>ğŸ’§ æ°´ç²¾éˆé¤Šæˆè¨˜ ğŸ’§</h1>
            <div class="level-info">
                <span class="level">Lv.<span id="level">1</span></span>
                <div class="exp-bar">
                    <div class="exp-fill" id="expFill"></div>
                    <span class="exp-text"><span id="currentExp">0</span>/<span id="maxExp">100</span> EXP</span>
                </div>
            </div>
        </header>

        <main>
            <section class="character-section">
                <div class="character" id="character">
                    <div class="water-sprite sprite-level-1">ğŸŒ±</div>
                    <div class="character-name" id="character-name">å°æ°´æ»´</div>
                </div>
            </section>

            <section class="stats-section">
                <div class="daily-goal progress-section">
                    <h3>ä»Šæ—¥ç›®æ¨™: 2000ml</h3>
                    <div class="progress-bar">
                        <div class="progress-fill" id="dailyProgress"></div>
                        <span class="progress-text"><span id="todayAmount">0</span>ml / 2000ml</span>
                    </div>
                </div>

                <div class="quick-actions quick-buttons">
                    <button class="drink-btn" onclick="addWater(250)">
                        <span class="icon">ğŸ¥¤</span>
                        <span>ä¸€æ¯æ°´<br>250ml</span>
                    </button>
                    <button class="drink-btn" onclick="addWater(500)">
                        <span class="icon">ğŸ¶</span>
                        <span>æ°´ç“¶<br>500ml</span>
                    </button>
                    <button class="drink-btn" onclick="addWater(100)">
                        <span class="icon">â˜•</span>
                        <span>å°å£<br>100ml</span>
                    </button>
                </div>

                <div class="custom-amount">
                    <input type="number" id="customAmount" placeholder="è‡ªè¨‚æ¯«å‡æ•¸" min="1" max="1000">
                    <button onclick="addCustomWater()">æ·»åŠ </button>
                </div>
            </section>

            <section class="history">
                <h3>ğŸ“Š ä»Šæ—¥è¨˜éŒ„</h3>
                <div class="history-list" id="historyList"></div>
            </section>
        </main>
    </div>

    <!-- æ¸¬è©¦é¢æ¿ -->
    <div class="test-panel">
        <h2>ğŸ§ª æ•´åˆæ¸¬è©¦</h2>
        
        <div class="test-section">
            <h3>å…ƒä»¶äº’å‹•æ¸¬è©¦</h3>
            <button class="test-button" onclick="testAddWater()">æ¸¬è©¦æ·»åŠ æ°´é‡</button>
            <button class="test-button" onclick="testProgressUpdate()">æ¸¬è©¦é€²åº¦æ›´æ–°</button>
            <button class="test-button" onclick="testExpGain()">æ¸¬è©¦ç¶“é©—å€¼å¢åŠ </button>
            <button class="test-button" onclick="testHistoryUpdate()">æ¸¬è©¦æ­·å²è¨˜éŒ„æ›´æ–°</button>
            <div id="component-result"></div>
        </div>

        <div class="test-section">
            <h3>æ•¸æ“šæµæ¸¬è©¦</h3>
            <button class="test-button" onclick="testDataPersistence()">æ¸¬è©¦æ•¸æ“šæŒä¹…åŒ–</button>
            <button class="test-button" onclick="testStateSync()">æ¸¬è©¦ç‹€æ…‹åŒæ­¥</button>
            <button class="test-button" onclick="testCacheInvalidation()">æ¸¬è©¦å¿«å–å¤±æ•ˆ</button>
            <div id="dataflow-result"></div>
        </div>

        <div class="test-section">
            <h3>éµç›¤å°èˆªæ¸¬è©¦</h3>
            <button class="test-button" onclick="testKeyboardNav()">æ¸¬è©¦ Tab å°èˆª</button>
            <button class="test-button" onclick="testFocusIndicators()">æ¸¬è©¦ç„¦é»æŒ‡ç¤ºå™¨</button>
            <button class="test-button" onclick="testAriaLabels()">æ¸¬è©¦ ARIA æ¨™ç±¤</button>
            <div id="keyboard-result"></div>
        </div>

        <div class="test-section">
            <h3>è·¨ç€è¦½å™¨æ¸¬è©¦</h3>
            <button class="test-button" onclick="testBrowserFeatures()">æª¢æ¸¬ç€è¦½å™¨åŠŸèƒ½</button>
            <button class="test-button" onclick="testLocalStorage()">æ¸¬è©¦ LocalStorage</button>
            <button class="test-button" onclick="testNotifications()">æ¸¬è©¦é€šçŸ¥æ”¯æ´</button>
            <div id="browser-result"></div>
        </div>

        <div class="test-log" id="testLog"></div>
    </div>

    <script src="script.js"></script>
    <script>
        // æ¸¬è©¦æ—¥èªŒå·¥å…·
        function log(message, type = 'info') {
            const logDiv = document.getElementById('testLog');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#ff7675' : type === 'success' ? '#00b894' : '#74b9ff';
            logDiv.innerHTML += `<div style="color: ${color}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function showResult(elementId, message, isSuccess) {
            const resultDiv = document.getElementById(elementId);
            resultDiv.innerHTML = `<div class="test-result ${isSuccess ? 'success' : 'error'}">${message}</div>`;
        }

        // ==================== å…ƒä»¶äº’å‹•æ¸¬è©¦ ====================
        
        function testAddWater() {
            log('é–‹å§‹æ¸¬è©¦æ·»åŠ æ°´é‡åŠŸèƒ½...');
            try {
                const initialAmount = gameData.todayAmount;
                addWater(250);
                
                setTimeout(() => {
                    const newAmount = gameData.todayAmount;
                    if (newAmount === initialAmount + 250) {
                        log('âœ“ æ·»åŠ æ°´é‡æˆåŠŸ', 'success');
                        showResult('component-result', 'âœ“ æ°´é‡æ­£ç¢ºå¢åŠ  250ml', true);
                    } else {
                        throw new Error(`é æœŸ ${initialAmount + 250}ï¼Œå¯¦éš› ${newAmount}`);
                    }
                }, 100);
            } catch (error) {
                log(`âœ— æ·»åŠ æ°´é‡å¤±æ•—: ${error.message}`, 'error');
                showResult('component-result', `âœ— æ¸¬è©¦å¤±æ•—: ${error.message}`, false);
            }
        }

        function testProgressUpdate() {
            log('é–‹å§‹æ¸¬è©¦é€²åº¦æ¢æ›´æ–°...');
            try {
                const progressBar = document.getElementById('dailyProgress');
                const initialWidth = progressBar.style.width;
                
                addWater(100);
                
                setTimeout(() => {
                    const newWidth = progressBar.style.width;
                    if (newWidth !== initialWidth) {
                        log('âœ“ é€²åº¦æ¢å·²æ›´æ–°', 'success');
                        showResult('component-result', `âœ“ é€²åº¦æ¢å¯¬åº¦: ${newWidth}`, true);
                    } else {
                        throw new Error('é€²åº¦æ¢æœªæ›´æ–°');
                    }
                }, 100);
            } catch (error) {
                log(`âœ— é€²åº¦æ¢æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
                showResult('component-result', `âœ— æ¸¬è©¦å¤±æ•—: ${error.message}`, false);
            }
        }

        function testExpGain() {
            log('é–‹å§‹æ¸¬è©¦ç¶“é©—å€¼å¢åŠ ...');
            try {
                const initialExp = gameData.exp;
                const amount = 250;
                const expectedExpGain = Math.floor(amount / 10);
                
                addWater(amount);
                
                setTimeout(() => {
                    const expGained = gameData.exp - initialExp;
                    if (expGained === expectedExpGain) {
                        log(`âœ“ ç¶“é©—å€¼æ­£ç¢ºå¢åŠ  ${expGained}`, 'success');
                        showResult('component-result', `âœ“ ç²å¾— ${expGained} ç¶“é©—å€¼`, true);
                    } else {
                        throw new Error(`é æœŸ ${expectedExpGain}ï¼Œå¯¦éš› ${expGained}`);
                    }
                }, 100);
            } catch (error) {
                log(`âœ— ç¶“é©—å€¼æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
                showResult('component-result', `âœ— æ¸¬è©¦å¤±æ•—: ${error.message}`, false);
            }
        }

        function testHistoryUpdate() {
            log('é–‹å§‹æ¸¬è©¦æ­·å²è¨˜éŒ„æ›´æ–°...');
            try {
                const initialCount = gameData.history.length;
                addWater(150);
                
                setTimeout(() => {
                    const newCount = gameData.history.length;
                    if (newCount === initialCount + 1) {
                        log('âœ“ æ­·å²è¨˜éŒ„å·²æ·»åŠ ', 'success');
                        showResult('component-result', `âœ“ è¨˜éŒ„æ•¸: ${newCount}`, true);
                    } else {
                        throw new Error(`é æœŸ ${initialCount + 1} ç­†è¨˜éŒ„ï¼Œå¯¦éš› ${newCount} ç­†`);
                    }
                }, 100);
            } catch (error) {
                log(`âœ— æ­·å²è¨˜éŒ„æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
                showResult('component-result', `âœ— æ¸¬è©¦å¤±æ•—: ${error.message}`, false);
            }
        }

        // ==================== æ•¸æ“šæµæ¸¬è©¦ ====================
        
        function testDataPersistence() {
            log('é–‹å§‹æ¸¬è©¦æ•¸æ“šæŒä¹…åŒ–...');
            try {
                const testData = { ...gameData };
                testData.todayAmount += 100;
                
                saveGameData();
                
                const saved = localStorage.getItem('waterGameData');
                if (saved) {
                    const parsed = JSON.parse(saved);
                    log('âœ“ æ•¸æ“šå·²å„²å­˜åˆ° LocalStorage', 'success');
                    showResult('dataflow-result', 'âœ“ æ•¸æ“šæŒä¹…åŒ–æ­£å¸¸', true);
                } else {
                    throw new Error('æ•¸æ“šæœªå„²å­˜');
                }
            } catch (error) {
                log(`âœ— æ•¸æ“šæŒä¹…åŒ–æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
                showResult('dataflow-result', `âœ— æ¸¬è©¦å¤±æ•—: ${error.message}`, false);
            }
        }

        function testStateSync() {
            log('é–‹å§‹æ¸¬è©¦ç‹€æ…‹åŒæ­¥...');
            try {
                const uiAmount = document.getElementById('todayAmount').textContent;
                const dataAmount = gameData.todayAmount.toString();
                
                if (uiAmount === dataAmount) {
                    log('âœ“ UI èˆ‡æ•¸æ“šç‹€æ…‹åŒæ­¥', 'success');
                    showResult('dataflow-result', `âœ“ ç‹€æ…‹ä¸€è‡´: ${uiAmount}ml`, true);
                } else {
                    throw new Error(`UI é¡¯ç¤º ${uiAmount}ï¼Œæ•¸æ“šç‚º ${dataAmount}`);
                }
            } catch (error) {
                log(`âœ— ç‹€æ…‹åŒæ­¥æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
                showResult('dataflow-result', `âœ— æ¸¬è©¦å¤±æ•—: ${error.message}`, false);
            }
        }

        function testCacheInvalidation() {
            log('é–‹å§‹æ¸¬è©¦å¿«å–å¤±æ•ˆ...');
            try {
                if (dashboardSystem) {
                    dashboardSystem.clearCache();
                    const cacheEmpty = dashboardSystem.cache.daily === null;
                    
                    if (cacheEmpty) {
                        log('âœ“ å¿«å–å·²æ¸…é™¤', 'success');
                        showResult('dataflow-result', 'âœ“ å¿«å–å¤±æ•ˆæ©Ÿåˆ¶æ­£å¸¸', true);
                    } else {
                        throw new Error('å¿«å–æœªæ¸…é™¤');
                    }
                } else {
                    log('âš  å„€è¡¨æ¿ç³»çµ±æœªåˆå§‹åŒ–', 'info');
                    showResult('dataflow-result', 'âš  å„€è¡¨æ¿ç³»çµ±æœªåˆå§‹åŒ–', false);
                }
            } catch (error) {
                log(`âœ— å¿«å–æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
                showResult('dataflow-result', `âœ— æ¸¬è©¦å¤±æ•—: ${error.message}`, false);
            }
        }

        // ==================== éµç›¤å°èˆªæ¸¬è©¦ ====================
        
        function testKeyboardNav() {
            log('é–‹å§‹æ¸¬è©¦éµç›¤å°èˆª...');
            try {
                const focusableElements = document.querySelectorAll(
                    'button, input, [tabindex]:not([tabindex="-1"])'
                );
                
                if (focusableElements.length > 0) {
                    log(`âœ“ æ‰¾åˆ° ${focusableElements.length} å€‹å¯èšç„¦å…ƒç´ `, 'success');
                    
                    // æ¸¬è©¦ç¬¬ä¸€å€‹å…ƒç´ æ˜¯å¦å¯èšç„¦
                    focusableElements[0].focus();
                    if (document.activeElement === focusableElements[0]) {
                        log('âœ“ å…ƒç´ å¯æ­£å¸¸èšç„¦', 'success');
                        showResult('keyboard-result', `âœ“ ${focusableElements.length} å€‹å…ƒç´ æ”¯æ´éµç›¤å°èˆª`, true);
                    } else {
                        throw new Error('å…ƒç´ ç„¡æ³•èšç„¦');
                    }
                } else {
                    throw new Error('æœªæ‰¾åˆ°å¯èšç„¦å…ƒç´ ');
                }
            } catch (error) {
                log(`âœ— éµç›¤å°èˆªæ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
                showResult('keyboard-result', `âœ— æ¸¬è©¦å¤±æ•—: ${error.message}`, false);
            }
        }

        function testFocusIndicators() {
            log('é–‹å§‹æ¸¬è©¦ç„¦é»æŒ‡ç¤ºå™¨...');
            try {
                const button = document.querySelector('.drink-btn');
                button.focus();
                
                const styles = window.getComputedStyle(button, ':focus-visible');
                log('âœ“ ç„¦é»æ¨£å¼å·²å¥—ç”¨', 'success');
                showResult('keyboard-result', 'âœ“ ç„¦é»æŒ‡ç¤ºå™¨æ­£å¸¸é¡¯ç¤º', true);
            } catch (error) {
                log(`âœ— ç„¦é»æŒ‡ç¤ºå™¨æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
                showResult('keyboard-result', `âœ— æ¸¬è©¦å¤±æ•—: ${error.message}`, false);
            }
        }

        function testAriaLabels() {
            log('é–‹å§‹æ¸¬è©¦ ARIA æ¨™ç±¤...');
            try {
                const elementsWithAria = document.querySelectorAll('[aria-label], [aria-labelledby], [role]');
                
                if (elementsWithAria.length > 0) {
                    log(`âœ“ æ‰¾åˆ° ${elementsWithAria.length} å€‹ ARIA å…ƒç´ `, 'success');
                    showResult('keyboard-result', `âœ“ ${elementsWithAria.length} å€‹å…ƒç´ æœ‰ ARIA å±¬æ€§`, true);
                } else {
                    log('âš  æœªæ‰¾åˆ° ARIA å…ƒç´ ', 'info');
                    showResult('keyboard-result', 'âš  å»ºè­°æ·»åŠ æ›´å¤š ARIA æ¨™ç±¤', false);
                }
            } catch (error) {
                log(`âœ— ARIA æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
                showResult('keyboard-result', `âœ— æ¸¬è©¦å¤±æ•—: ${error.message}`, false);
            }
        }

        // ==================== è·¨ç€è¦½å™¨æ¸¬è©¦ ====================
        
        function testBrowserFeatures() {
            log('é–‹å§‹æª¢æ¸¬ç€è¦½å™¨åŠŸèƒ½...');
            try {
                const features = {
                    'LocalStorage': 'localStorage' in window,
                    'Notification': 'Notification' in window,
                    'Canvas': !!document.createElement('canvas').getContext,
                    'ES6': typeof Symbol !== 'undefined',
                    'Fetch': 'fetch' in window
                };
                
                let report = 'ç€è¦½å™¨åŠŸèƒ½æ”¯æ´:<br>';
                for (const [feature, supported] of Object.entries(features)) {
                    const icon = supported ? 'âœ“' : 'âœ—';
                    report += `${icon} ${feature}<br>`;
                    log(`${icon} ${feature}: ${supported ? 'æ”¯æ´' : 'ä¸æ”¯æ´'}`, supported ? 'success' : 'error');
                }
                
                showResult('browser-result', report, true);
            } catch (error) {
                log(`âœ— ç€è¦½å™¨æª¢æ¸¬å¤±æ•—: ${error.message}`, 'error');
                showResult('browser-result', `âœ— æ¸¬è©¦å¤±æ•—: ${error.message}`, false);
            }
        }

        function testLocalStorage() {
            log('é–‹å§‹æ¸¬è©¦ LocalStorage...');
            try {
                const testKey = '__test__';
                const testValue = 'test_value';
                
                localStorage.setItem(testKey, testValue);
                const retrieved = localStorage.getItem(testKey);
                localStorage.removeItem(testKey);
                
                if (retrieved === testValue) {
                    log('âœ“ LocalStorage è®€å¯«æ­£å¸¸', 'success');
                    showResult('browser-result', 'âœ“ LocalStorage åŠŸèƒ½æ­£å¸¸', true);
                } else {
                    throw new Error('LocalStorage è®€å¯«å¤±æ•—');
                }
            } catch (error) {
                log(`âœ— LocalStorage æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
                showResult('browser-result', `âœ— æ¸¬è©¦å¤±æ•—: ${error.message}`, false);
            }
        }

        function testNotifications() {
            log('é–‹å§‹æ¸¬è©¦é€šçŸ¥æ”¯æ´...');
            try {
                if ('Notification' in window) {
                    const permission = Notification.permission;
                    log(`âœ“ é€šçŸ¥ API å¯ç”¨ï¼Œæ¬Šé™ç‹€æ…‹: ${permission}`, 'success');
                    showResult('browser-result', `âœ“ é€šçŸ¥æ”¯æ´ (æ¬Šé™: ${permission})`, true);
                } else {
                    log('âœ— ç€è¦½å™¨ä¸æ”¯æ´é€šçŸ¥ API', 'error');
                    showResult('browser-result', 'âœ— ç€è¦½å™¨ä¸æ”¯æ´é€šçŸ¥', false);
                }
            } catch (error) {
                log(`âœ— é€šçŸ¥æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
                showResult('browser-result', `âœ— æ¸¬è©¦å¤±æ•—: ${error.message}`, false);
            }
        }

        // åˆå§‹åŒ–æ—¥èªŒ
        log('æ•´åˆæ¸¬è©¦é¢æ¿å·²å°±ç·’');
        log('é»æ“Šæ¸¬è©¦æŒ‰éˆ•é–‹å§‹æ¸¬è©¦');
    </script>
</body>
</html>
